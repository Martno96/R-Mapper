{"ast":null,"code":"import * as util from '../util/index.mjs';\nimport V from '../V/index.mjs';\nimport { Rect, Point } from '../g/index.mjs';\nimport * as Port from '../layout/ports/port.mjs';\nimport * as PortLabel from '../layout/ports/portLabel.mjs';\n\nvar PortData = function (data) {\n  var clonedData = util.cloneDeep(data) || {};\n  this.ports = [];\n  this.groups = {};\n  this.portLayoutNamespace = Port;\n  this.portLabelLayoutNamespace = PortLabel;\n\n  this._init(clonedData);\n};\n\nPortData.prototype = {\n  getPorts: function () {\n    return this.ports;\n  },\n  getGroup: function (name) {\n    return this.groups[name] || {};\n  },\n  getPortsByGroup: function (groupName) {\n    return this.ports.filter(function (port) {\n      return port.group === groupName;\n    });\n  },\n  getGroupPortsMetrics: function (groupName, elBBox) {\n    var group = this.getGroup(groupName);\n    var ports = this.getPortsByGroup(groupName);\n    var groupPosition = group.position || {};\n    var groupPositionName = groupPosition.name;\n    var namespace = this.portLayoutNamespace;\n\n    if (!namespace[groupPositionName]) {\n      groupPositionName = 'left';\n    }\n\n    var groupArgs = groupPosition.args || {};\n    var portsArgs = ports.map(function (port) {\n      return port && port.position && port.position.args;\n    });\n    var groupPortTransformations = namespace[groupPositionName](portsArgs, elBBox, groupArgs);\n    var accumulator = {\n      ports: ports,\n      result: []\n    };\n    util.toArray(groupPortTransformations).reduce(function (res, portTransformation, index) {\n      var port = res.ports[index];\n      res.result.push({\n        portId: port.id,\n        portTransformation: portTransformation,\n        labelTransformation: this._getPortLabelLayout(port, Point(portTransformation), elBBox),\n        portAttrs: port.attrs,\n        portSize: port.size,\n        labelSize: port.label.size\n      });\n      return res;\n    }.bind(this), accumulator);\n    return accumulator.result;\n  },\n  _getPortLabelLayout: function (port, portPosition, elBBox) {\n    var namespace = this.portLabelLayoutNamespace;\n    var labelPosition = port.label.position.name || 'left';\n\n    if (namespace[labelPosition]) {\n      return namespace[labelPosition](portPosition, elBBox, port.label.position.args);\n    }\n\n    return null;\n  },\n  _init: function (data) {\n    // prepare groups\n    if (util.isObject(data.groups)) {\n      var groups = Object.keys(data.groups);\n\n      for (var i = 0, n = groups.length; i < n; i++) {\n        var key = groups[i];\n        this.groups[key] = this._evaluateGroup(data.groups[key]);\n      }\n    } // prepare ports\n\n\n    var ports = util.toArray(data.items);\n\n    for (var j = 0, m = ports.length; j < m; j++) {\n      this.ports.push(this._evaluatePort(ports[j]));\n    }\n  },\n  _evaluateGroup: function (group) {\n    return util.merge(group, {\n      position: this._getPosition(group.position, true),\n      label: this._getLabel(group, true)\n    });\n  },\n  _evaluatePort: function (port) {\n    var evaluated = util.assign({}, port);\n    var group = this.getGroup(port.group);\n    evaluated.markup = evaluated.markup || group.markup;\n    evaluated.attrs = util.merge({}, group.attrs, evaluated.attrs);\n    evaluated.position = this._createPositionNode(group, evaluated);\n    evaluated.label = util.merge({}, group.label, this._getLabel(evaluated));\n    evaluated.z = this._getZIndex(group, evaluated);\n    evaluated.size = util.assign({}, group.size, evaluated.size);\n    return evaluated;\n  },\n  _getZIndex: function (group, port) {\n    if (util.isNumber(port.z)) {\n      return port.z;\n    }\n\n    if (util.isNumber(group.z) || group.z === 'auto') {\n      return group.z;\n    }\n\n    return 'auto';\n  },\n  _createPositionNode: function (group, port) {\n    return util.merge({\n      name: 'left',\n      args: {}\n    }, group.position, {\n      args: port.args\n    });\n  },\n  _getPosition: function (position, setDefault) {\n    var args = {};\n    var positionName;\n\n    if (util.isFunction(position)) {\n      positionName = 'fn';\n      args.fn = position;\n    } else if (util.isString(position)) {\n      positionName = position;\n    } else if (position === undefined) {\n      positionName = setDefault ? 'left' : null;\n    } else if (Array.isArray(position)) {\n      positionName = 'absolute';\n      args.x = position[0];\n      args.y = position[1];\n    } else if (util.isObject(position)) {\n      positionName = position.name;\n      util.assign(args, position.args);\n    }\n\n    var result = {\n      args: args\n    };\n\n    if (positionName) {\n      result.name = positionName;\n    }\n\n    return result;\n  },\n  _getLabel: function (item, setDefaults) {\n    var label = item.label || {};\n    var ret = label;\n    ret.position = this._getPosition(label.position, setDefaults);\n    return ret;\n  }\n};\nexport const elementPortPrototype = {\n  _initializePorts: function () {\n    this._createPortData();\n\n    this.on('change:ports', function () {\n      this._processRemovedPort();\n\n      this._createPortData();\n    }, this);\n  },\n\n  /**\n   * remove links tied wiht just removed element\n   * @private\n   */\n  _processRemovedPort: function () {\n    var current = this.get('ports') || {};\n    var currentItemsMap = {};\n    util.toArray(current.items).forEach(function (item) {\n      currentItemsMap[item.id] = true;\n    });\n    var previous = this.previous('ports') || {};\n    var removed = {};\n    util.toArray(previous.items).forEach(function (item) {\n      if (!currentItemsMap[item.id]) {\n        removed[item.id] = true;\n      }\n    });\n    var graph = this.graph;\n\n    if (graph && !util.isEmpty(removed)) {\n      var inboundLinks = graph.getConnectedLinks(this, {\n        inbound: true\n      });\n      inboundLinks.forEach(function (link) {\n        if (removed[link.get('target').port]) link.remove();\n      });\n      var outboundLinks = graph.getConnectedLinks(this, {\n        outbound: true\n      });\n      outboundLinks.forEach(function (link) {\n        if (removed[link.get('source').port]) link.remove();\n      });\n    }\n  },\n\n  /**\n   * @returns {boolean}\n   */\n  hasPorts: function () {\n    var ports = this.prop('ports/items');\n    return Array.isArray(ports) && ports.length > 0;\n  },\n\n  /**\n   * @param {string} id\n   * @returns {boolean}\n   */\n  hasPort: function (id) {\n    return this.getPortIndex(id) !== -1;\n  },\n\n  /**\n   * @returns {Array<object>}\n   */\n  getPorts: function () {\n    return util.cloneDeep(this.prop('ports/items')) || [];\n  },\n\n  /**\n   * @returns {Array<object>}\n   */\n  getGroupPorts: function (groupName) {\n    const groupPorts = util.toArray(this.prop(['ports', 'items'])).filter(port => port.group === groupName);\n    return util.cloneDeep(groupPorts);\n  },\n\n  /**\n   * @param {string} id\n   * @returns {object}\n   */\n  getPort: function (id) {\n    return util.cloneDeep(util.toArray(this.prop('ports/items')).find(function (port) {\n      return port.id && port.id === id;\n    }));\n  },\n\n  /**\n   * @param {string} groupName\n   * @returns {Object<portId, {x: number, y: number, angle: number}>}\n   */\n  getPortsPositions: function (groupName) {\n    var portsMetrics = this._portSettingsData.getGroupPortsMetrics(groupName, Rect(this.size()));\n\n    return portsMetrics.reduce(function (positions, metrics) {\n      var transformation = metrics.portTransformation;\n      positions[metrics.portId] = {\n        x: transformation.x,\n        y: transformation.y,\n        angle: transformation.angle\n      };\n      return positions;\n    }, {});\n  },\n\n  /**\n   * @param {string|Port} port port id or port\n   * @returns {number} port index\n   */\n  getPortIndex: function (port) {\n    var id = util.isObject(port) ? port.id : port;\n\n    if (!this._isValidPortId(id)) {\n      return -1;\n    }\n\n    return util.toArray(this.prop('ports/items')).findIndex(function (item) {\n      return item.id === id;\n    });\n  },\n\n  /**\n   * @param {object} port\n   * @param {object} [opt]\n   * @returns {joint.dia.Element}\n   */\n  addPort: function (port, opt) {\n    if (!util.isObject(port) || Array.isArray(port)) {\n      throw new Error('Element: addPort requires an object.');\n    }\n\n    var ports = util.assign([], this.prop('ports/items'));\n    ports.push(port);\n    this.prop('ports/items', ports, opt);\n    return this;\n  },\n\n  /**\n   * @param {string|Port|number} before\n   * @param {object} port\n   * @param {object} [opt]\n   * @returns {joint.dia.Element}\n   */\n  insertPort: function (before, port, opt) {\n    const index = typeof before === 'number' ? before : this.getPortIndex(before);\n\n    if (!util.isObject(port) || Array.isArray(port)) {\n      throw new Error('dia.Element: insertPort requires an object.');\n    }\n\n    const ports = util.assign([], this.prop('ports/items'));\n    ports.splice(index, 0, port);\n    this.prop('ports/items', ports, opt);\n    return this;\n  },\n\n  /**\n   * @param {string} portId\n   * @param {string|object=} path\n   * @param {*=} value\n   * @param {object=} opt\n   * @returns {joint.dia.Element}\n   */\n  portProp: function (portId, path, value, opt) {\n    var index = this.getPortIndex(portId);\n\n    if (index === -1) {\n      throw new Error('Element: unable to find port with id ' + portId);\n    }\n\n    var args = Array.prototype.slice.call(arguments, 1);\n\n    if (Array.isArray(path)) {\n      args[0] = ['ports', 'items', index].concat(path);\n    } else if (util.isString(path)) {\n      // Get/set an attribute by a special path syntax that delimits\n      // nested objects by the colon character.\n      args[0] = ['ports/items/', index, '/', path].join('');\n    } else {\n      args = ['ports/items/' + index];\n\n      if (util.isPlainObject(path)) {\n        args.push(path);\n        args.push(value);\n      }\n    }\n\n    return this.prop.apply(this, args);\n  },\n  _validatePorts: function () {\n    var portsAttr = this.get('ports') || {};\n    var errorMessages = [];\n    portsAttr = portsAttr || {};\n    var ports = util.toArray(portsAttr.items);\n    ports.forEach(function (p) {\n      if (typeof p !== 'object') {\n        errorMessages.push('Element: invalid port ', p);\n      }\n\n      if (!this._isValidPortId(p.id)) {\n        p.id = this.generatePortId();\n      }\n    }, this);\n\n    if (util.uniq(ports, 'id').length !== ports.length) {\n      errorMessages.push('Element: found id duplicities in ports.');\n    }\n\n    return errorMessages;\n  },\n  generatePortId: function () {\n    return this.generateId();\n  },\n\n  /**\n   * @param {string} id port id\n   * @returns {boolean}\n   * @private\n   */\n  _isValidPortId: function (id) {\n    return id !== null && id !== undefined && !util.isObject(id);\n  },\n  addPorts: function (ports, opt) {\n    if (ports.length) {\n      this.prop('ports/items', util.assign([], this.prop('ports/items')).concat(ports), opt);\n    }\n\n    return this;\n  },\n  removePort: function (port, opt) {\n    const options = opt || {};\n    const index = this.getPortIndex(port);\n\n    if (index !== -1) {\n      const ports = util.assign([], this.prop(['ports', 'items']));\n      ports.splice(index, 1);\n      options.rewrite = true;\n      this.startBatch('port-remove');\n      this.prop(['ports', 'items'], ports, options);\n      this.stopBatch('port-remove');\n    }\n\n    return this;\n  },\n  removePorts: function (portsForRemoval, opt) {\n    let options, newPorts;\n\n    if (Array.isArray(portsForRemoval)) {\n      options = opt || {};\n      if (portsForRemoval.length === 0) return this.this;\n      const currentPorts = util.assign([], this.prop(['ports', 'items']));\n      newPorts = currentPorts.filter(function (cp) {\n        return !portsForRemoval.some(function (rp) {\n          const rpId = util.isObject(rp) ? rp.id : rp;\n          return cp.id === rpId;\n        });\n      });\n    } else {\n      options = portsForRemoval || {};\n      newPorts = [];\n    }\n\n    this.startBatch('port-remove');\n    options.rewrite = true;\n    this.prop(['ports', 'items'], newPorts, options);\n    this.stopBatch('port-remove');\n    return this;\n  },\n\n  /**\n   * @private\n   */\n  _createPortData: function () {\n    var err = this._validatePorts();\n\n    if (err.length > 0) {\n      this.set('ports', this.previous('ports'));\n      throw new Error(err.join(' '));\n    }\n\n    var prevPortData;\n\n    if (this._portSettingsData) {\n      prevPortData = this._portSettingsData.getPorts();\n    }\n\n    this._portSettingsData = new PortData(this.get('ports'));\n\n    var curPortData = this._portSettingsData.getPorts();\n\n    if (prevPortData) {\n      var added = curPortData.filter(function (item) {\n        if (!prevPortData.find(function (prevPort) {\n          return prevPort.id === item.id;\n        })) {\n          return item;\n        }\n      });\n      var removed = prevPortData.filter(function (item) {\n        if (!curPortData.find(function (curPort) {\n          return curPort.id === item.id;\n        })) {\n          return item;\n        }\n      });\n\n      if (removed.length > 0) {\n        this.trigger('ports:remove', this, removed);\n      }\n\n      if (added.length > 0) {\n        this.trigger('ports:add', this, added);\n      }\n    }\n  }\n};\nexport const elementViewPortPrototype = {\n  portContainerMarkup: 'g',\n  portMarkup: [{\n    tagName: 'circle',\n    selector: 'circle',\n    attributes: {\n      'r': 10,\n      'fill': '#FFFFFF',\n      'stroke': '#000000'\n    }\n  }],\n  portLabelMarkup: [{\n    tagName: 'text',\n    selector: 'text',\n    attributes: {\n      'fill': '#000000'\n    }\n  }],\n\n  /** @type {Object<string, {portElement: Vectorizer, portLabelElement: Vectorizer}>} */\n  _portElementsCache: null,\n\n  /**\n   * @private\n   */\n  _initializePorts: function () {\n    this._cleanPortsCache();\n  },\n\n  /**\n   * @typedef {Object} Port\n   *\n   * @property {string} id\n   * @property {Object} position\n   * @property {Object} label\n   * @property {Object} attrs\n   * @property {string} markup\n   * @property {string} group\n   */\n\n  /**\n   * @private\n   */\n  _refreshPorts: function () {\n    this._removePorts();\n\n    this._cleanPortsCache();\n\n    this._renderPorts();\n  },\n  _cleanPortsCache: function () {\n    this._portElementsCache = {};\n  },\n\n  /**\n   * @private\n   */\n  _renderPorts: function () {\n    // references to rendered elements without z-index\n    var elementReferences = [];\n\n    var elem = this._getContainerElement();\n\n    for (var i = 0, count = elem.node.childNodes.length; i < count; i++) {\n      elementReferences.push(elem.node.childNodes[i]);\n    }\n\n    var portsGropsByZ = util.groupBy(this.model._portSettingsData.getPorts(), 'z');\n    var withoutZKey = 'auto'; // render non-z first\n\n    util.toArray(portsGropsByZ[withoutZKey]).forEach(function (port) {\n      var portElement = this._getPortElement(port);\n\n      elem.append(portElement);\n      elementReferences.push(portElement);\n    }, this);\n    var groupNames = Object.keys(portsGropsByZ);\n\n    for (var k = 0; k < groupNames.length; k++) {\n      var groupName = groupNames[k];\n\n      if (groupName !== withoutZKey) {\n        var z = parseInt(groupName, 10);\n\n        this._appendPorts(portsGropsByZ[groupName], z, elementReferences);\n      }\n    }\n\n    this._updatePorts();\n  },\n\n  /**\n   * @returns {V}\n   * @private\n   */\n  _getContainerElement: function () {\n    return this.rotatableNode || this.vel;\n  },\n\n  /**\n   * @param {Array<Port>}ports\n   * @param {number} z\n   * @param refs\n   * @private\n   */\n  _appendPorts: function (ports, z, refs) {\n    var containerElement = this._getContainerElement();\n\n    var portElements = util.toArray(ports).map(this._getPortElement, this);\n\n    if (refs[z] || z < 0) {\n      V(refs[Math.max(z, 0)]).before(portElements);\n    } else {\n      containerElement.append(portElements);\n    }\n  },\n\n  /**\n   * Try to get element from cache,\n   * @param port\n   * @returns {*}\n   * @private\n   */\n  _getPortElement: function (port) {\n    if (this._portElementsCache[port.id]) {\n      return this._portElementsCache[port.id].portElement;\n    }\n\n    return this._createPortElement(port);\n  },\n  findPortNode: function (portId, selector) {\n    const portCache = this._portElementsCache[portId];\n    if (!portCache) return null;\n    const portRoot = portCache.portContentElement.node;\n    const portSelectors = portCache.portContentSelectors;\n    const [node = null] = this.findBySelector(selector, portRoot, portSelectors);\n    return node;\n  },\n\n  /**\n   * @private\n   */\n  _updatePorts: function () {\n    // layout ports without group\n    this._updatePortGroup(undefined); // layout ports with explicit group\n\n\n    var groupsNames = Object.keys(this.model._portSettingsData.groups);\n    groupsNames.forEach(this._updatePortGroup, this);\n  },\n\n  /**\n   * @private\n   */\n  _removePorts: function () {\n    util.invoke(this._portElementsCache, 'portElement.remove');\n  },\n\n  /**\n   * @param {Port} port\n   * @returns {V}\n   * @private\n   */\n  _createPortElement: function (port) {\n    var portElement;\n    var labelElement;\n    var portContainerElement = V(this.portContainerMarkup).addClass('joint-port');\n\n    var portMarkup = this._getPortMarkup(port);\n\n    var portSelectors;\n\n    if (Array.isArray(portMarkup)) {\n      var portDoc = this.parseDOMJSON(portMarkup, portContainerElement.node);\n      var portFragment = portDoc.fragment;\n\n      if (portFragment.childNodes.length > 1) {\n        portElement = V('g').append(portFragment);\n      } else {\n        portElement = V(portFragment.firstChild);\n      }\n\n      portSelectors = portDoc.selectors;\n    } else {\n      portElement = V(portMarkup);\n\n      if (Array.isArray(portElement)) {\n        portElement = V('g').append(portElement);\n      }\n    }\n\n    if (!portElement) {\n      throw new Error('ElementView: Invalid port markup.');\n    }\n\n    portElement.attr({\n      'port': port.id,\n      'port-group': port.group\n    });\n\n    var labelMarkup = this._getPortLabelMarkup(port.label);\n\n    var labelSelectors;\n\n    if (Array.isArray(labelMarkup)) {\n      var labelDoc = this.parseDOMJSON(labelMarkup, portContainerElement.node);\n      var labelFragment = labelDoc.fragment;\n\n      if (labelFragment.childNodes.length > 1) {\n        labelElement = V('g').append(labelFragment);\n      } else {\n        labelElement = V(labelFragment.firstChild);\n      }\n\n      labelSelectors = labelDoc.selectors;\n    } else {\n      labelElement = V(labelMarkup);\n\n      if (Array.isArray(labelElement)) {\n        labelElement = V('g').append(labelElement);\n      }\n    }\n\n    if (!labelElement) {\n      throw new Error('ElementView: Invalid port label markup.');\n    }\n\n    var portContainerSelectors;\n\n    if (portSelectors && labelSelectors) {\n      for (var key in labelSelectors) {\n        if (portSelectors[key] && key !== this.selector) throw new Error('ElementView: selectors within port must be unique.');\n      }\n\n      portContainerSelectors = util.assign({}, portSelectors, labelSelectors);\n    } else {\n      portContainerSelectors = portSelectors || labelSelectors;\n    }\n\n    portContainerElement.append([portElement.addClass('joint-port-body'), labelElement.addClass('joint-port-label')]);\n    this._portElementsCache[port.id] = {\n      portElement: portContainerElement,\n      portLabelElement: labelElement,\n      portSelectors: portContainerSelectors,\n      portLabelSelectors: labelSelectors,\n      portContentElement: portElement,\n      portContentSelectors: portSelectors\n    };\n    return portContainerElement;\n  },\n\n  /**\n   * @param {string=} groupName\n   * @private\n   */\n  _updatePortGroup: function (groupName) {\n    var elementBBox = Rect(this.model.size());\n\n    var portsMetrics = this.model._portSettingsData.getGroupPortsMetrics(groupName, elementBBox);\n\n    for (var i = 0, n = portsMetrics.length; i < n; i++) {\n      var metrics = portsMetrics[i];\n      var portId = metrics.portId;\n      var cached = this._portElementsCache[portId] || {};\n      var portTransformation = metrics.portTransformation;\n      this.applyPortTransform(cached.portElement, portTransformation);\n      this.updateDOMSubtreeAttributes(cached.portElement.node, metrics.portAttrs, {\n        rootBBox: new Rect(metrics.portSize),\n        selectors: cached.portSelectors\n      });\n      var labelTransformation = metrics.labelTransformation;\n\n      if (labelTransformation) {\n        this.applyPortTransform(cached.portLabelElement, labelTransformation, -portTransformation.angle || 0);\n        this.updateDOMSubtreeAttributes(cached.portLabelElement.node, labelTransformation.attrs, {\n          rootBBox: new Rect(metrics.labelSize),\n          selectors: cached.portLabelSelectors\n        });\n      }\n    }\n  },\n\n  /**\n   * @param {Vectorizer} element\n   * @param {{dx:number, dy:number, angle: number, attrs: Object, x:number: y:number}} transformData\n   * @param {number=} initialAngle\n   * @constructor\n   */\n  applyPortTransform: function (element, transformData, initialAngle) {\n    var matrix = V.createSVGMatrix().rotate(initialAngle || 0).translate(transformData.x || 0, transformData.y || 0).rotate(transformData.angle || 0);\n    element.transform(matrix, {\n      absolute: true\n    });\n  },\n\n  /**\n   * @param {Port} port\n   * @returns {string}\n   * @private\n   */\n  _getPortMarkup: function (port) {\n    return port.markup || this.model.get('portMarkup') || this.model.portMarkup || this.portMarkup;\n  },\n\n  /**\n   * @param {Object} label\n   * @returns {string}\n   * @private\n   */\n  _getPortLabelMarkup: function (label) {\n    return label.markup || this.model.get('portLabelMarkup') || this.model.portLabelMarkup || this.portLabelMarkup;\n  }\n};","map":{"version":3,"sources":["C:/Users/martn/Documents/New Documents 2019/Technigo codin/storymapper spreadsheet/my-app/node_modules/jointjs/src/dia/ports.mjs"],"names":["util","V","Rect","Point","Port","PortLabel","PortData","data","clonedData","cloneDeep","ports","groups","portLayoutNamespace","portLabelLayoutNamespace","_init","prototype","getPorts","getGroup","name","getPortsByGroup","groupName","filter","port","group","getGroupPortsMetrics","elBBox","groupPosition","position","groupPositionName","namespace","groupArgs","args","portsArgs","map","groupPortTransformations","accumulator","result","toArray","reduce","res","portTransformation","index","push","portId","id","labelTransformation","_getPortLabelLayout","portAttrs","attrs","portSize","size","labelSize","label","bind","portPosition","labelPosition","isObject","Object","keys","i","n","length","key","_evaluateGroup","items","j","m","_evaluatePort","merge","_getPosition","_getLabel","evaluated","assign","markup","_createPositionNode","z","_getZIndex","isNumber","setDefault","positionName","isFunction","fn","isString","undefined","Array","isArray","x","y","item","setDefaults","ret","elementPortPrototype","_initializePorts","_createPortData","on","_processRemovedPort","current","get","currentItemsMap","forEach","previous","removed","graph","isEmpty","inboundLinks","getConnectedLinks","inbound","link","remove","outboundLinks","outbound","hasPorts","prop","hasPort","getPortIndex","getGroupPorts","groupPorts","getPort","find","getPortsPositions","portsMetrics","_portSettingsData","positions","metrics","transformation","angle","_isValidPortId","findIndex","addPort","opt","Error","insertPort","before","splice","portProp","path","value","slice","call","arguments","concat","join","isPlainObject","apply","_validatePorts","portsAttr","errorMessages","p","generatePortId","uniq","generateId","addPorts","removePort","options","rewrite","startBatch","stopBatch","removePorts","portsForRemoval","newPorts","this","currentPorts","cp","some","rp","rpId","err","set","prevPortData","curPortData","added","prevPort","curPort","trigger","elementViewPortPrototype","portContainerMarkup","portMarkup","tagName","selector","attributes","portLabelMarkup","_portElementsCache","_cleanPortsCache","_refreshPorts","_removePorts","_renderPorts","elementReferences","elem","_getContainerElement","count","node","childNodes","portsGropsByZ","groupBy","model","withoutZKey","portElement","_getPortElement","append","groupNames","k","parseInt","_appendPorts","_updatePorts","rotatableNode","vel","refs","containerElement","portElements","Math","max","_createPortElement","findPortNode","portCache","portRoot","portContentElement","portSelectors","portContentSelectors","findBySelector","_updatePortGroup","groupsNames","invoke","labelElement","portContainerElement","addClass","_getPortMarkup","portDoc","parseDOMJSON","portFragment","fragment","firstChild","selectors","attr","labelMarkup","_getPortLabelMarkup","labelSelectors","labelDoc","labelFragment","portContainerSelectors","portLabelElement","portLabelSelectors","elementBBox","cached","applyPortTransform","updateDOMSubtreeAttributes","rootBBox","element","transformData","initialAngle","matrix","createSVGMatrix","rotate","translate","transform","absolute"],"mappings":"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","sourcesContent":["import * as util from '../util/index.mjs';\nimport V from '../V/index.mjs';\nimport { Rect, Point } from '../g/index.mjs';\nimport * as Port from '../layout/ports/port.mjs';\nimport * as PortLabel from '../layout/ports/portLabel.mjs';\n\nvar PortData = function(data) {\n\n    var clonedData = util.cloneDeep(data) || {};\n    this.ports = [];\n    this.groups = {};\n    this.portLayoutNamespace = Port;\n    this.portLabelLayoutNamespace = PortLabel;\n\n    this._init(clonedData);\n};\n\nPortData.prototype = {\n\n    getPorts: function() {\n        return this.ports;\n    },\n\n    getGroup: function(name) {\n        return this.groups[name] || {};\n    },\n\n    getPortsByGroup: function(groupName) {\n\n        return this.ports.filter(function(port) {\n            return port.group === groupName;\n        });\n    },\n\n    getGroupPortsMetrics: function(groupName, elBBox) {\n\n        var group = this.getGroup(groupName);\n        var ports = this.getPortsByGroup(groupName);\n\n        var groupPosition = group.position || {};\n        var groupPositionName = groupPosition.name;\n        var namespace = this.portLayoutNamespace;\n        if (!namespace[groupPositionName]) {\n            groupPositionName = 'left';\n        }\n\n        var groupArgs = groupPosition.args || {};\n        var portsArgs = ports.map(function(port) {\n            return port && port.position && port.position.args;\n        });\n        var groupPortTransformations = namespace[groupPositionName](portsArgs, elBBox, groupArgs);\n\n        var accumulator = {\n            ports: ports,\n            result: []\n        };\n\n        util.toArray(groupPortTransformations).reduce(function(res, portTransformation, index) {\n            var port = res.ports[index];\n            res.result.push({\n                portId: port.id,\n                portTransformation: portTransformation,\n                labelTransformation: this._getPortLabelLayout(port, Point(portTransformation), elBBox),\n                portAttrs: port.attrs,\n                portSize: port.size,\n                labelSize: port.label.size\n            });\n            return res;\n        }.bind(this), accumulator);\n\n        return accumulator.result;\n    },\n\n    _getPortLabelLayout: function(port, portPosition, elBBox) {\n\n        var namespace = this.portLabelLayoutNamespace;\n        var labelPosition = port.label.position.name || 'left';\n\n        if (namespace[labelPosition]) {\n            return namespace[labelPosition](portPosition, elBBox, port.label.position.args);\n        }\n\n        return null;\n    },\n\n    _init: function(data) {\n\n        // prepare groups\n        if (util.isObject(data.groups)) {\n            var groups = Object.keys(data.groups);\n            for (var i = 0, n = groups.length; i < n; i++) {\n                var key = groups[i];\n                this.groups[key] = this._evaluateGroup(data.groups[key]);\n            }\n        }\n\n        // prepare ports\n        var ports = util.toArray(data.items);\n        for (var j = 0, m = ports.length; j < m; j++) {\n            this.ports.push(this._evaluatePort(ports[j]));\n        }\n    },\n\n    _evaluateGroup: function(group) {\n\n        return util.merge(group, {\n            position: this._getPosition(group.position, true),\n            label: this._getLabel(group, true)\n        });\n    },\n\n    _evaluatePort: function(port) {\n\n        var evaluated = util.assign({}, port);\n\n        var group = this.getGroup(port.group);\n\n        evaluated.markup = evaluated.markup || group.markup;\n        evaluated.attrs = util.merge({}, group.attrs, evaluated.attrs);\n        evaluated.position = this._createPositionNode(group, evaluated);\n        evaluated.label = util.merge({}, group.label, this._getLabel(evaluated));\n        evaluated.z = this._getZIndex(group, evaluated);\n        evaluated.size = util.assign({}, group.size, evaluated.size);\n\n        return evaluated;\n    },\n\n    _getZIndex: function(group, port) {\n\n        if (util.isNumber(port.z)) {\n            return port.z;\n        }\n        if (util.isNumber(group.z) || group.z === 'auto') {\n            return group.z;\n        }\n        return 'auto';\n    },\n\n    _createPositionNode: function(group, port) {\n\n        return util.merge({\n            name: 'left',\n            args: {}\n        }, group.position, { args: port.args });\n    },\n\n    _getPosition: function(position, setDefault) {\n\n        var args = {};\n        var positionName;\n\n        if (util.isFunction(position)) {\n            positionName = 'fn';\n            args.fn = position;\n        } else if (util.isString(position)) {\n            positionName = position;\n        } else if (position === undefined) {\n            positionName = setDefault ? 'left' : null;\n        } else if (Array.isArray(position)) {\n            positionName = 'absolute';\n            args.x = position[0];\n            args.y = position[1];\n        } else if (util.isObject(position)) {\n            positionName = position.name;\n            util.assign(args, position.args);\n        }\n\n        var result = { args: args };\n\n        if (positionName) {\n            result.name = positionName;\n        }\n        return result;\n    },\n\n    _getLabel: function(item, setDefaults) {\n\n        var label = item.label || {};\n\n        var ret = label;\n        ret.position = this._getPosition(label.position, setDefaults);\n\n        return ret;\n    }\n};\n\nexport const elementPortPrototype = {\n\n    _initializePorts: function() {\n\n        this._createPortData();\n        this.on('change:ports', function() {\n\n            this._processRemovedPort();\n            this._createPortData();\n        }, this);\n    },\n\n    /**\n     * remove links tied wiht just removed element\n     * @private\n     */\n    _processRemovedPort: function() {\n\n        var current = this.get('ports') || {};\n        var currentItemsMap = {};\n\n        util.toArray(current.items).forEach(function(item) {\n            currentItemsMap[item.id] = true;\n        });\n\n        var previous = this.previous('ports') || {};\n        var removed = {};\n\n        util.toArray(previous.items).forEach(function(item) {\n            if (!currentItemsMap[item.id]) {\n                removed[item.id] = true;\n            }\n        });\n\n        var graph = this.graph;\n        if (graph && !util.isEmpty(removed)) {\n\n            var inboundLinks = graph.getConnectedLinks(this, { inbound: true });\n            inboundLinks.forEach(function(link) {\n\n                if (removed[link.get('target').port]) link.remove();\n            });\n\n            var outboundLinks = graph.getConnectedLinks(this, { outbound: true });\n            outboundLinks.forEach(function(link) {\n\n                if (removed[link.get('source').port]) link.remove();\n            });\n        }\n    },\n\n    /**\n     * @returns {boolean}\n     */\n    hasPorts: function() {\n\n        var ports = this.prop('ports/items');\n        return Array.isArray(ports) && ports.length > 0;\n    },\n\n    /**\n     * @param {string} id\n     * @returns {boolean}\n     */\n    hasPort: function(id) {\n\n        return this.getPortIndex(id) !== -1;\n    },\n\n    /**\n     * @returns {Array<object>}\n     */\n    getPorts: function() {\n\n        return util.cloneDeep(this.prop('ports/items')) || [];\n    },\n\n    /**\n     * @returns {Array<object>}\n     */\n    getGroupPorts: function(groupName) {\n        const groupPorts = util.toArray(this.prop(['ports','items'])).filter(port => port.group === groupName);\n        return util.cloneDeep(groupPorts);\n    },\n\n    /**\n     * @param {string} id\n     * @returns {object}\n     */\n    getPort: function(id) {\n\n        return util.cloneDeep(util.toArray(this.prop('ports/items')).find(function(port) {\n            return port.id && port.id === id;\n        }));\n    },\n\n    /**\n     * @param {string} groupName\n     * @returns {Object<portId, {x: number, y: number, angle: number}>}\n     */\n    getPortsPositions: function(groupName) {\n\n        var portsMetrics = this._portSettingsData.getGroupPortsMetrics(groupName, Rect(this.size()));\n\n        return portsMetrics.reduce(function(positions, metrics) {\n            var transformation = metrics.portTransformation;\n            positions[metrics.portId] = {\n                x: transformation.x,\n                y: transformation.y,\n                angle: transformation.angle\n            };\n            return positions;\n        }, {});\n    },\n\n    /**\n     * @param {string|Port} port port id or port\n     * @returns {number} port index\n     */\n    getPortIndex: function(port) {\n\n        var id = util.isObject(port) ? port.id : port;\n\n        if (!this._isValidPortId(id)) {\n            return -1;\n        }\n\n        return util.toArray(this.prop('ports/items')).findIndex(function(item) {\n            return item.id === id;\n        });\n    },\n\n    /**\n     * @param {object} port\n     * @param {object} [opt]\n     * @returns {joint.dia.Element}\n     */\n    addPort: function(port, opt) {\n\n        if (!util.isObject(port) || Array.isArray(port)) {\n            throw new Error('Element: addPort requires an object.');\n        }\n\n        var ports = util.assign([], this.prop('ports/items'));\n        ports.push(port);\n        this.prop('ports/items', ports, opt);\n\n        return this;\n    },\n\n    /**\n     * @param {string|Port|number} before\n     * @param {object} port\n     * @param {object} [opt]\n     * @returns {joint.dia.Element}\n     */\n    insertPort: function(before, port, opt) {\n        const index = (typeof before === 'number') ? before : this.getPortIndex(before);\n\n        if (!util.isObject(port) || Array.isArray(port)) {\n            throw new Error('dia.Element: insertPort requires an object.');\n        }\n\n        const ports = util.assign([], this.prop('ports/items'));\n        ports.splice(index, 0, port);\n        this.prop('ports/items', ports, opt);\n\n        return this;\n    },\n\n    /**\n     * @param {string} portId\n     * @param {string|object=} path\n     * @param {*=} value\n     * @param {object=} opt\n     * @returns {joint.dia.Element}\n     */\n    portProp: function(portId, path, value, opt) {\n\n        var index = this.getPortIndex(portId);\n\n        if (index === -1) {\n            throw new Error('Element: unable to find port with id ' + portId);\n        }\n\n        var args = Array.prototype.slice.call(arguments, 1);\n        if (Array.isArray(path)) {\n            args[0] = ['ports', 'items', index].concat(path);\n        } else if (util.isString(path)) {\n\n            // Get/set an attribute by a special path syntax that delimits\n            // nested objects by the colon character.\n            args[0] = ['ports/items/', index, '/', path].join('');\n\n        } else {\n\n            args = ['ports/items/' + index];\n            if (util.isPlainObject(path)) {\n                args.push(path);\n                args.push(value);\n            }\n        }\n\n        return this.prop.apply(this, args);\n    },\n\n    _validatePorts: function() {\n\n        var portsAttr = this.get('ports') || {};\n\n        var errorMessages = [];\n        portsAttr = portsAttr || {};\n        var ports = util.toArray(portsAttr.items);\n\n        ports.forEach(function(p) {\n\n            if (typeof p !== 'object') {\n                errorMessages.push('Element: invalid port ', p);\n            }\n\n            if (!this._isValidPortId(p.id)) {\n                p.id = this.generatePortId();\n            }\n        }, this);\n\n        if (util.uniq(ports, 'id').length !== ports.length) {\n            errorMessages.push('Element: found id duplicities in ports.');\n        }\n\n        return errorMessages;\n    },\n\n    generatePortId: function() {\n        return this.generateId();\n    },\n\n    /**\n     * @param {string} id port id\n     * @returns {boolean}\n     * @private\n     */\n    _isValidPortId: function(id) {\n\n        return id !== null && id !== undefined && !util.isObject(id);\n    },\n\n    addPorts: function(ports, opt) {\n\n        if (ports.length) {\n            this.prop('ports/items', util.assign([], this.prop('ports/items')).concat(ports), opt);\n        }\n\n        return this;\n    },\n\n    removePort: function(port, opt) {\n        const options = opt || {};\n        const index = this.getPortIndex(port);\n        if (index !== -1) {\n            const ports = util.assign([], this.prop(['ports', 'items']));\n            ports.splice(index, 1);\n            options.rewrite = true;\n            this.startBatch('port-remove');\n            this.prop(['ports', 'items'], ports, options);\n            this.stopBatch('port-remove');\n        }\n        return this;\n    },\n\n    removePorts: function(portsForRemoval, opt) {\n        let options, newPorts;\n        if (Array.isArray(portsForRemoval)) {\n            options = opt || {};\n            if (portsForRemoval.length === 0) return this.this;\n            const currentPorts = util.assign([], this.prop(['ports', 'items']));\n            newPorts = currentPorts.filter(function(cp) {\n                return !portsForRemoval.some(function(rp) {\n                    const rpId = util.isObject(rp) ? rp.id : rp;\n                    return cp.id === rpId;\n                });\n            });\n        } else {\n            options = portsForRemoval || {};\n            newPorts = [];\n        }\n        this.startBatch('port-remove');\n        options.rewrite = true;\n        this.prop(['ports', 'items'], newPorts, options);\n        this.stopBatch('port-remove');\n        return this;\n    },\n\n    /**\n     * @private\n     */\n    _createPortData: function() {\n\n        var err = this._validatePorts();\n\n        if (err.length > 0) {\n            this.set('ports', this.previous('ports'));\n            throw new Error(err.join(' '));\n        }\n\n        var prevPortData;\n\n        if (this._portSettingsData) {\n\n            prevPortData = this._portSettingsData.getPorts();\n        }\n\n        this._portSettingsData = new PortData(this.get('ports'));\n\n        var curPortData = this._portSettingsData.getPorts();\n\n        if (prevPortData) {\n\n            var added = curPortData.filter(function(item) {\n                if (!prevPortData.find(function(prevPort) {\n                    return prevPort.id === item.id;\n                })) {\n                    return item;\n                }\n            });\n\n            var removed = prevPortData.filter(function(item) {\n                if (!curPortData.find(function(curPort) {\n                    return curPort.id === item.id;\n                })) {\n                    return item;\n                }\n            });\n\n            if (removed.length > 0) {\n                this.trigger('ports:remove', this, removed);\n            }\n\n            if (added.length > 0) {\n                this.trigger('ports:add', this, added);\n            }\n        }\n    }\n};\n\nexport const elementViewPortPrototype = {\n\n    portContainerMarkup: 'g',\n    portMarkup: [{\n        tagName: 'circle',\n        selector: 'circle',\n        attributes: {\n            'r': 10,\n            'fill': '#FFFFFF',\n            'stroke': '#000000'\n        }\n    }],\n    portLabelMarkup: [{\n        tagName: 'text',\n        selector: 'text',\n        attributes: {\n            'fill': '#000000'\n        }\n    }],\n    /** @type {Object<string, {portElement: Vectorizer, portLabelElement: Vectorizer}>} */\n    _portElementsCache: null,\n\n    /**\n     * @private\n     */\n    _initializePorts: function() {\n        this._cleanPortsCache();\n    },\n\n    /**\n     * @typedef {Object} Port\n     *\n     * @property {string} id\n     * @property {Object} position\n     * @property {Object} label\n     * @property {Object} attrs\n     * @property {string} markup\n     * @property {string} group\n     */\n\n    /**\n     * @private\n     */\n    _refreshPorts: function() {\n\n        this._removePorts();\n        this._cleanPortsCache();\n        this._renderPorts();\n    },\n\n    _cleanPortsCache: function() {\n        this._portElementsCache = {};\n    },\n\n    /**\n     * @private\n     */\n    _renderPorts: function() {\n\n        // references to rendered elements without z-index\n        var elementReferences = [];\n        var elem = this._getContainerElement();\n\n        for (var i = 0, count = elem.node.childNodes.length; i < count; i++) {\n            elementReferences.push(elem.node.childNodes[i]);\n        }\n\n        var portsGropsByZ = util.groupBy(this.model._portSettingsData.getPorts(), 'z');\n        var withoutZKey = 'auto';\n\n        // render non-z first\n        util.toArray(portsGropsByZ[withoutZKey]).forEach(function(port) {\n            var portElement = this._getPortElement(port);\n            elem.append(portElement);\n            elementReferences.push(portElement);\n        }, this);\n\n        var groupNames = Object.keys(portsGropsByZ);\n        for (var k = 0; k < groupNames.length; k++) {\n            var groupName = groupNames[k];\n            if (groupName !== withoutZKey) {\n                var z = parseInt(groupName, 10);\n                this._appendPorts(portsGropsByZ[groupName], z, elementReferences);\n            }\n        }\n\n        this._updatePorts();\n    },\n\n    /**\n     * @returns {V}\n     * @private\n     */\n    _getContainerElement: function() {\n\n        return this.rotatableNode || this.vel;\n    },\n\n    /**\n     * @param {Array<Port>}ports\n     * @param {number} z\n     * @param refs\n     * @private\n     */\n    _appendPorts: function(ports, z, refs) {\n\n        var containerElement = this._getContainerElement();\n        var portElements = util.toArray(ports).map(this._getPortElement, this);\n\n        if (refs[z] || z < 0) {\n            V(refs[Math.max(z, 0)]).before(portElements);\n        } else {\n            containerElement.append(portElements);\n        }\n    },\n\n    /**\n     * Try to get element from cache,\n     * @param port\n     * @returns {*}\n     * @private\n     */\n    _getPortElement: function(port) {\n\n        if (this._portElementsCache[port.id]) {\n            return this._portElementsCache[port.id].portElement;\n        }\n        return this._createPortElement(port);\n    },\n\n    findPortNode: function(portId, selector) {\n        const portCache = this._portElementsCache[portId];\n        if (!portCache) return null;\n        const portRoot = portCache.portContentElement.node;\n        const portSelectors = portCache.portContentSelectors;\n        const [node = null] = this.findBySelector(selector, portRoot, portSelectors);\n        return node;\n    },\n\n    /**\n     * @private\n     */\n    _updatePorts: function() {\n\n        // layout ports without group\n        this._updatePortGroup(undefined);\n        // layout ports with explicit group\n        var groupsNames = Object.keys(this.model._portSettingsData.groups);\n        groupsNames.forEach(this._updatePortGroup, this);\n    },\n\n    /**\n     * @private\n     */\n    _removePorts: function() {\n        util.invoke(this._portElementsCache, 'portElement.remove');\n    },\n\n    /**\n     * @param {Port} port\n     * @returns {V}\n     * @private\n     */\n    _createPortElement: function(port) {\n\n        var portElement;\n        var labelElement;\n\n        var portContainerElement = V(this.portContainerMarkup).addClass('joint-port');\n\n        var portMarkup = this._getPortMarkup(port);\n        var portSelectors;\n        if (Array.isArray(portMarkup)) {\n            var portDoc = this.parseDOMJSON(portMarkup, portContainerElement.node);\n            var portFragment = portDoc.fragment;\n            if (portFragment.childNodes.length > 1) {\n                portElement = V('g').append(portFragment);\n            } else {\n                portElement = V(portFragment.firstChild);\n            }\n            portSelectors = portDoc.selectors;\n        } else {\n            portElement = V(portMarkup);\n            if (Array.isArray(portElement)) {\n                portElement = V('g').append(portElement);\n            }\n        }\n\n        if (!portElement) {\n            throw new Error('ElementView: Invalid port markup.');\n        }\n\n        portElement.attr({\n            'port': port.id,\n            'port-group': port.group\n        });\n\n        var labelMarkup = this._getPortLabelMarkup(port.label);\n        var labelSelectors;\n        if (Array.isArray(labelMarkup)) {\n            var labelDoc = this.parseDOMJSON(labelMarkup, portContainerElement.node);\n            var labelFragment = labelDoc.fragment;\n            if (labelFragment.childNodes.length > 1) {\n                labelElement = V('g').append(labelFragment);\n            } else {\n                labelElement = V(labelFragment.firstChild);\n            }\n            labelSelectors = labelDoc.selectors;\n        } else {\n            labelElement = V(labelMarkup);\n            if (Array.isArray(labelElement)) {\n                labelElement = V('g').append(labelElement);\n            }\n        }\n\n        if (!labelElement) {\n            throw new Error('ElementView: Invalid port label markup.');\n        }\n\n        var portContainerSelectors;\n        if (portSelectors && labelSelectors) {\n            for (var key in labelSelectors) {\n                if (portSelectors[key] && key !== this.selector) throw new Error('ElementView: selectors within port must be unique.');\n            }\n            portContainerSelectors = util.assign({}, portSelectors, labelSelectors);\n        } else {\n            portContainerSelectors = portSelectors || labelSelectors;\n        }\n\n        portContainerElement.append([\n            portElement.addClass('joint-port-body'),\n            labelElement.addClass('joint-port-label')\n        ]);\n\n        this._portElementsCache[port.id] = {\n            portElement: portContainerElement,\n            portLabelElement: labelElement,\n            portSelectors: portContainerSelectors,\n            portLabelSelectors: labelSelectors,\n            portContentElement: portElement,\n            portContentSelectors: portSelectors\n        };\n\n        return portContainerElement;\n    },\n\n    /**\n     * @param {string=} groupName\n     * @private\n     */\n    _updatePortGroup: function(groupName) {\n\n        var elementBBox = Rect(this.model.size());\n        var portsMetrics = this.model._portSettingsData.getGroupPortsMetrics(groupName, elementBBox);\n\n        for (var i = 0, n = portsMetrics.length; i < n; i++) {\n            var metrics = portsMetrics[i];\n            var portId = metrics.portId;\n            var cached = this._portElementsCache[portId] || {};\n            var portTransformation = metrics.portTransformation;\n            this.applyPortTransform(cached.portElement, portTransformation);\n            this.updateDOMSubtreeAttributes(cached.portElement.node, metrics.portAttrs, {\n                rootBBox: new Rect(metrics.portSize),\n                selectors: cached.portSelectors\n            });\n\n            var labelTransformation = metrics.labelTransformation;\n            if (labelTransformation) {\n                this.applyPortTransform(cached.portLabelElement, labelTransformation, (-portTransformation.angle || 0));\n                this.updateDOMSubtreeAttributes(cached.portLabelElement.node, labelTransformation.attrs, {\n                    rootBBox: new Rect(metrics.labelSize),\n                    selectors: cached.portLabelSelectors\n                });\n            }\n        }\n    },\n\n    /**\n     * @param {Vectorizer} element\n     * @param {{dx:number, dy:number, angle: number, attrs: Object, x:number: y:number}} transformData\n     * @param {number=} initialAngle\n     * @constructor\n     */\n    applyPortTransform: function(element, transformData, initialAngle) {\n\n        var matrix = V.createSVGMatrix()\n            .rotate(initialAngle || 0)\n            .translate(transformData.x || 0, transformData.y || 0)\n            .rotate(transformData.angle || 0);\n\n        element.transform(matrix, { absolute: true });\n    },\n\n    /**\n     * @param {Port} port\n     * @returns {string}\n     * @private\n     */\n    _getPortMarkup: function(port) {\n\n        return port.markup || this.model.get('portMarkup') || this.model.portMarkup || this.portMarkup;\n    },\n\n    /**\n     * @param {Object} label\n     * @returns {string}\n     * @private\n     */\n    _getPortLabelMarkup: function(label) {\n\n        return label.markup || this.model.get('portLabelMarkup') || this.model.portLabelMarkup || this.portLabelMarkup;\n    }\n};\n\n"]},"metadata":{},"sourceType":"module"}